<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="只记空山，只念新雨">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      Spring5源码解析-使用@Valid进行Spring验证 | 一叶知秋
    
  </title>
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/gitment.css">
  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>
  <script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


</head>
<div class="wechat-share">
  <img src="/css/images/logo.png">
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>一叶知秋</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Spring5源码解析-使用@Valid进行Spring验证</h2>
  <p class="post-date">2017-08-11</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h1 id="Spring5源码解析-使用-Valid进行Spring验证"><a href="#Spring5源码解析-使用-Valid进行Spring验证" class="headerlink" title="Spring5源码解析-使用@Valid进行Spring验证"></a>Spring5源码解析-使用@Valid进行Spring验证</h1><blockquote>
<p>验证功能在Spring中是很常用的。你可以使用注解或自己的验证器并将其绑定到请求中。本文将重点介绍第一种解决方案。</p>
</blockquote>
<p>第一部分将介绍注解验证流程。在第二部分中，将介绍基本实现的组件。最后一部分将包含Spring初学者开发人员常见错误的解释:是否有必要直接在验证对象之后放置<code>BindingResult</code>。<br><a id="more"></a></p>
<h2 id="使用-Valid注解在Spring中进行验证流程"><a href="#使用-Valid注解在Spring中进行验证流程" class="headerlink" title="使用@Valid注解在Spring中进行验证流程"></a>使用@Valid注解在Spring中进行验证流程</h2><p>要了解使用<code>标准Java @Valid</code>或<code>特定Spring @Validated</code>注解的验证过程，我们首先需要了解Spring如何解析使用了<code>@ModelAttribute</code>注解的对象。它们在controller的方法签名进行注解。@ModelAttribute注解用于将动态请求参数<code>转换</code>为Java注解中指定的对象。例如，观察代码<strong>@ModelAttribute(“article”)Article article </strong>,Spring会尝试将所有请求参数匹配到Article类的字段中。现在，假设这个类有两个字段:<code>title</code>和<code>content</code>。如果请求包含<code>title</code>和<code>content</code>参数，它们将被用作<code>Article</code>的<code>title</code>和<code>content</code>的值(后面会对<code>@ModelAttribute</code>方面的源码做进一步的分析)。</p>
<p>当我们有对象需要进行验证时，<code>@ModelAttribute</code>注解的处理器(<strong>org.springframework.web.method.annotation.ModelAttributeMethodProcessor</strong>)会检查是否必须应用验证注解。注解验证必须以“Valid”这个字眼开头。接下来，对象通过<strong>org.springframework.validation.DataBinder</strong>类中的<strong>public void validate(Object … validationHints)</strong>进行<strong>验证</strong>。该方法遍历所有可用的验证器，并调用每个验证器的<code>validate</code>方法。验证器取自带有<code>validator</code>ID的bean。这样，它可以与<code>annotation-driven</code>的xml配置相关联:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span> <span class="attr">validator</span>=<span class="string">"validator"</span> &gt;</span></span><br></pre></td></tr></table></figure>
<p>如果未指定验证器bean，则将使用默认验证器:<strong>org.springframework.validation.beanvalidation.LocalValidatorFactoryBean</strong>。</p>
<h2 id="如何在Spring中处理验证？"><a href="#如何在Spring中处理验证？" class="headerlink" title="如何在Spring中处理验证？"></a>如何在Spring中处理验证？</h2><p>我们已经了解了验证流程。现在，我们可以专注于验证过程本身，即验证器是如何知道一个字段不正确的。<code>LocalValidatorFactoryBean</code>继承自同一个包下的<code>SpringValidatorAdapter</code>，但不会覆盖其的validate()方法。这些方法用于检查验证字段是否正确。更准确地说，<code>SpringValidatorAdapter</code>包含一个目标验证器字段(<code>Validator</code>类型的<code>targetValidator</code>)。它将在<code>validate()</code>方法中使用来验证已验证对象的所有字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringValidatorAdapter</span> <span class="keyword">implements</span> <span class="title">SmartValidator</span>, <span class="title">javax</span>.<span class="title">validation</span>.<span class="title">Validator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; internalAnnotationAttributes = <span class="keyword">new</span> HashSet&lt;&gt;(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		internalAnnotationAttributes.add(<span class="string">"message"</span>);</span><br><span class="line">		internalAnnotationAttributes.add(<span class="string">"groups"</span>);</span><br><span class="line">		internalAnnotationAttributes.add(<span class="string">"payload"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> javax.validation.Validator targetValidator;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new SpringValidatorAdapter for the given JSR-303 Validator.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> targetValidator the JSR-303 Validator to wrap</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SpringValidatorAdapter</span><span class="params">(javax.validation.Validator targetValidator)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(targetValidator, <span class="string">"Target Validator must not be null"</span>);</span><br><span class="line">		<span class="keyword">this</span>.targetValidator = targetValidator;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	SpringValidatorAdapter() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setTargetValidator</span><span class="params">(javax.validation.Validator targetValidator)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.targetValidator = targetValidator;</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(@Nullable Object target, Errors errors)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.targetValidator != <span class="keyword">null</span>) &#123;</span><br><span class="line">			processConstraintViolations(<span class="keyword">this</span>.targetValidator.validate(target), errors);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(@Nullable Object target, Errors errors, @Nullable Object... validationHints)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.targetValidator != <span class="keyword">null</span>) &#123;</span><br><span class="line">			Set&lt;Class&lt;?&gt;&gt; groups = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">			<span class="keyword">if</span> (validationHints != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">for</span> (Object hint : validationHints) &#123;</span><br><span class="line">					<span class="keyword">if</span> (hint <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">						groups.add((Class&lt;?&gt;) hint);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			processConstraintViolations(</span><br><span class="line">					<span class="keyword">this</span>.targetValidator.validate(target, groups.toArray(<span class="keyword">new</span> Class&lt;?&gt;[groups.size()])), errors);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>此验证的结果是由在<code>SpringValidatorAdapter</code>内的<code>protected void processConstraintViolations(Set&lt;ConstraintViolation&lt;Object&gt;&gt; violations, Errors errors)</code>方法处理得到。它将错误从JSR-303验证器附加到给定的Spring的错误对象(觉得别扭请看下面方法上的英文注释)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Process the given JSR-303 ConstraintViolations, adding corresponding errors to</span></span><br><span class="line"><span class="comment">	 * the provided Spring &#123;<span class="doctag">@link</span> Errors&#125; object.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> violations the JSR-303 ConstraintViolation results</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> errors the Spring errors object to register to</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processConstraintViolations</span><span class="params">(Set&lt;ConstraintViolation&lt;Object&gt;&gt; violations, Errors errors)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (ConstraintViolation&lt;Object&gt; violation : violations) &#123;</span><br><span class="line">			String field = determineField(violation);</span><br><span class="line">			FieldError fieldError = errors.getFieldError(field);</span><br><span class="line">			<span class="keyword">if</span> (fieldError == <span class="keyword">null</span> || !fieldError.isBindingFailure()) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					ConstraintDescriptor&lt;?&gt; cd = violation.getConstraintDescriptor();</span><br><span class="line">					String errorCode = determineErrorCode(cd);</span><br><span class="line">					Object[] errorArgs = getArgumentsForConstraint(errors.getObjectName(), field, cd);</span><br><span class="line">					<span class="keyword">if</span> (errors <span class="keyword">instanceof</span> BindingResult) &#123;</span><br><span class="line">						<span class="comment">// Can do custom FieldError registration with invalid value from ConstraintViolation,</span></span><br><span class="line">						<span class="comment">// as necessary for Hibernate Validator compatibility (non-indexed set path in field)</span></span><br><span class="line">						BindingResult bindingResult = (BindingResult) errors;</span><br><span class="line">						String nestedField = bindingResult.getNestedPath() + field;</span><br><span class="line">						<span class="keyword">if</span> (<span class="string">""</span>.equals(nestedField)) &#123;</span><br><span class="line">							String[] errorCodes = bindingResult.resolveMessageCodes(errorCode);</span><br><span class="line">							bindingResult.addError(<span class="keyword">new</span> ObjectError(</span><br><span class="line">									errors.getObjectName(), errorCodes, errorArgs, violation.getMessage()));</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span> &#123;</span><br><span class="line">							Object rejectedValue = getRejectedValue(field, violation, bindingResult);</span><br><span class="line">							String[] errorCodes = bindingResult.resolveMessageCodes(errorCode, field);</span><br><span class="line">							bindingResult.addError(<span class="keyword">new</span> FieldError(</span><br><span class="line">									errors.getObjectName(), nestedField, rejectedValue, <span class="keyword">false</span>,</span><br><span class="line">									errorCodes, errorArgs, violation.getMessage()));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="comment">// got no BindingResult - can only do standard rejectValue call</span></span><br><span class="line">						<span class="comment">// with automatic extraction of the current field value</span></span><br><span class="line">						errors.rejectValue(field, errorCode, errorArgs, violation.getMessage());</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (NotReadablePropertyException ex) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"JSR-303 validated property '"</span> + field +</span><br><span class="line">							<span class="string">"' does not have a corresponding accessor for Spring data binding - "</span> +</span><br><span class="line">							<span class="string">"check your DataBinder's configuration (bean property versus direct field access)"</span>, ex);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>验证错误直接附加到<code>DataBinder</code>的<strong>private AbstractPropertyBindingResult bindingResult</strong>字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataBinder</span> <span class="keyword">implements</span> <span class="title">PropertyEditorRegistry</span>, <span class="title">TypeConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Default object name used for binding: "target" */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_OBJECT_NAME = <span class="string">"target"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Default limit for array and collection growing: 256 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_AUTO_GROW_COLLECTION_LIMIT = <span class="number">256</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * We'll create a lot of DataBinder instances: Let's use a static logger.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(DataBinder.class);</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Object target;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String objectName;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> AbstractPropertyBindingResult bindingResult;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> SimpleTypeConverter typeConverter;</span><br></pre></td></tr></table></figure>
<p>此时它的值会在<code>ModelAttributeMethodProcessor</code>中检索:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (binder.getBindingResult().hasErrors()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BindException(binder.getBindingResult());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="controller方法内获取BindingResult"><a href="#controller方法内获取BindingResult" class="headerlink" title="controller方法内获取BindingResult"></a>controller方法内获取BindingResult</h2><p>需要注意的是，要在控制器的方法中检索<code>BindingResult</code>，必须将<code>BindingResult</code>实例直接放在经过验证的对象之后。具体请看<strong>public String addArticle(@ModelAttribute(“article”) @Valid Article article, BindingResult result)</strong>，<code>BindingResult</code>的实例将包含所有的验证错误。这时，如果你在<code>Article</code>和<code>BindingResult</code>实例之间放置另一个对象(例如:<code>HttpServletRequest request</code>)，将抛出如下异常:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">An Errors/BindingResult argument is expected to be declared immediately after the  model attribute, the @RequestBody or the @RequestPart arguments to which they apply.</span><br></pre></td></tr></table></figure>
<p>此错误消息的内容可以在<strong>org.springframework.web.method.annotation.ErrorsMethodArgumentResolver</strong>类中找到。此类用于从方法签名中解析错误实例。如果问为什么用<code>ErrorsMethodArgumentResolver</code>来解析<code>BindingResults</code>？简单来说，这是由于<code>BindingResult</code>接口扩展了<code>Errors</code>接口的缘故。所以，两者都可以用相同的参数解析器解决。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Resolves &#123;<span class="doctag">@link</span> Errors&#125; method arguments.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;An &#123;<span class="doctag">@code</span> Errors&#125; method argument is expected to appear immediately after</span></span><br><span class="line"><span class="comment"> * the model attribute in the method signature. It is resolved by expecting the</span></span><br><span class="line"><span class="comment"> * last two attributes added to the model to be the model attribute and its</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> BindingResult&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rossen Stoyanchev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorsMethodArgumentResolver</span> <span class="keyword">implements</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">		Class&lt;?&gt; paramType = parameter.getParameterType();</span><br><span class="line">		<span class="keyword">return</span> Errors.class.isAssignableFrom(paramType);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">			NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		Assert.state(mavContainer != <span class="keyword">null</span>, <span class="string">"Errors/BindingResult argument only supported on regular handler methods"</span>);</span><br><span class="line"></span><br><span class="line">		ModelMap model = mavContainer.getModel();</span><br><span class="line">		<span class="keyword">if</span> (model.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">int</span> lastIndex = model.size()-<span class="number">1</span>;</span><br><span class="line">			String lastKey = <span class="keyword">new</span> ArrayList&lt;&gt;(model.keySet()).get(lastIndex);</span><br><span class="line">			<span class="keyword">if</span> (lastKey.startsWith(BindingResult.MODEL_KEY_PREFIX)) &#123;</span><br><span class="line">				<span class="keyword">return</span> model.get(lastKey);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">				<span class="string">"An Errors/BindingResult argument is expected to be declared immediately after the model attribute, "</span> +</span><br><span class="line">				<span class="string">"the @RequestBody or the @RequestPart arguments to which they apply: "</span> + parameter.getMethod());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面代码可以看出，由于BindingResult的放置的位置 不正确，而导致验证过程失败的方法其实很简单:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ModelMap model = mavContainer.getModel();</span><br><span class="line"><span class="keyword">if</span> (model.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> lastIndex = model.size()-<span class="number">1</span>;</span><br><span class="line">    String lastKey = <span class="keyword">new</span> ArrayList&lt;String&gt;(model.keySet()).get(lastIndex);</span><br><span class="line">    <span class="keyword">if</span> (lastKey.startsWith(BindingResult.MODEL_KEY_PREFIX)) &#123;</span><br><span class="line">        <span class="keyword">return</span> model.get(lastKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，它获得用于构建视图部分的模型数据的ModelMap。所要验证对象和<code>BindingResult</code>如果放置正确，那么所要打印的日志应该如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">model equals to &#123;article=Article &#123;text = &#125;, org.springframework.validation.BindingResult.article=org.springframework.validation.BeanPropertyBindingResult: <span class="number">1</span> errors</span><br><span class="line">Field error in object <span class="string">'article'</span> on field <span class="string">'text'</span>: rejected value []; codes [NotEmpty.article.text,NotEmpty.text,NotEmpty.java.lang.String,NotEmpty]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [article.text,text]; arguments []; <span class="keyword">default</span> message [text]]; <span class="keyword">default</span> message [Text can<span class="string">'t be empty]&#125;</span></span><br></pre></td></tr></table></figure>
<p>之后，将值放在<code>ArrayList</code>中，并获取最后一个 entry key。然后，检查此键是否以<code>org.springframework.validation.BindingResult</code>开头(BindingResult 接口的常量值)。如果是，该方法返回发现的Errors实例。否则，将抛出一个IllegalStateException异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BindingResult</span> <span class="keyword">extends</span> <span class="title">Errors</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Prefix for the name of the BindingResult instance in a model,</span></span><br><span class="line"><span class="comment">	 * followed by the object name.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String MODEL_KEY_PREFIX = BindingResult.class.getName() + <span class="string">"."</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return the wrapped target object, which may be a bean, an object with</span></span><br><span class="line"><span class="comment">	 * public fields, a Map - depending on the concrete binding strategy.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">Object <span class="title">getTarget</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>这篇文章讲了Spring 验证的一些过程细节。它的第一部分介绍了验证流程，从@ModelAttribute开始，并以验证器集合结束。第二部分看了看基本的Spring验证器。在最后，我们看到一个非常常见的bug，基于直接在验证对象之后放置BindingResult实例，并解释了其中的原理所在。</p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#Spring">
    <span class="tag-code">Spring</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2017/08/07/Spring5源码解析-Spring中的处理拦截器/">
        <span class="nav-arrow">← </span>
        
          Spring5源码解析-Spring中的处理拦截器
        
      </a>
    
    
      <a class="nav-right" href="/2017/08/17/Spring5源码解析-@ModelAttribute/">
        
          Spring5源码解析-@ModelAttribute
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
      <div class="money-like">
        <div class="reward-btn">
          赏
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>使用支付宝打赏</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>使用微信打赏</b>
            </span>
          </span>
        </div>
        <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
      </div>
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">扫描二维码，分享此文章</p>
      </div>
    
    <!-- 二维码 END -->
    
      <!-- Gitment START -->
      <div id="comments"></div>
      <!-- Gitment END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Spring5源码解析-使用-Valid进行Spring验证"><span class="toc-nav-text">Spring5源码解析-使用@Valid进行Spring验证</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#使用-Valid注解在Spring中进行验证流程"><span class="toc-nav-text">使用@Valid注解在Spring中进行验证流程</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#如何在Spring中处理验证？"><span class="toc-nav-text">如何在Spring中处理验证？</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#controller方法内获取BindingResult"><span class="toc-nav-text">controller方法内获取BindingResult</span></a></li></ol></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'https://muyinchen.github.io/2017/08/11/Spring5源码解析-使用@Valid进行Spring验证/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()
        
        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

    // gitment
    var gitmentConfig = "yanm1ng";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "Spring5源码解析-使用@Valid进行Spring验证",
        owner: "yanm1ng",
        repo: "yanm1ng.github.io",
        oauth: {
          client_id: "0f87e490e00ee3fd87ef",
          client_secret: "4a9d2b148e7971c2201ad12131ce8bf8159ccd2e"
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  })();
</script>

<script>
  var disqus_shortname = '';
  
  var disqus_url = 'https://muyinchen.github.io/2017/08/11/Spring5源码解析-使用@Valid进行Spring验证/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2019 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->

<script src="/js/script.js"></script>
  </body>
</html>