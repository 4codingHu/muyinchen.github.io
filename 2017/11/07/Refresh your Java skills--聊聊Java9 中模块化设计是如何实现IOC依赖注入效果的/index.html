<!doctype html>



  


<html class="theme-next mist use-motion">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Java">





  <link rel="alternate" href="/atom.xml" title="一叶知秋" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2">






<meta name="description" content="Refresh your Java skills–聊聊Java9 中模块化设计是如何实现类似IOC依赖注入效果及与其区别场景引入如何实现IOC的效果，我们可以来想想，无非就是一个隐式实现，而想要做到，总不能什么都没有，来个巧妇难为无米之炊的境地吧，所以说，米必须要有滴，在Spring中就是一个bean，也就是说，容器里得有米，再官话点就是上下文中得存在所需要的bean。同样模块化中两个互相隔离的模">
<meta name="keywords" content="Java">
<meta property="og:type" content="article">
<meta property="og:title" content="Refresh your Java skills--聊聊Java9 中模块化设计是如何实现类似IOC依赖注入效果及与其区别">
<meta property="og:url" content="https://muyinchen.github.io/2017/11/07/Refresh your Java skills--聊聊Java9 中模块化设计是如何实现IOC依赖注入效果的/index.html">
<meta property="og:site_name" content="一叶知秋">
<meta property="og:description" content="Refresh your Java skills–聊聊Java9 中模块化设计是如何实现类似IOC依赖注入效果及与其区别场景引入如何实现IOC的效果，我们可以来想想，无非就是一个隐式实现，而想要做到，总不能什么都没有，来个巧妇难为无米之炊的境地吧，所以说，米必须要有滴，在Spring中就是一个bean，也就是说，容器里得有米，再官话点就是上下文中得存在所需要的bean。同样模块化中两个互相隔离的模">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-11-12T08:47:54.812Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Refresh your Java skills--聊聊Java9 中模块化设计是如何实现类似IOC依赖注入效果及与其区别">
<meta name="twitter:description" content="Refresh your Java skills–聊聊Java9 中模块化设计是如何实现类似IOC依赖注入效果及与其区别场景引入如何实现IOC的效果，我们可以来想想，无非就是一个隐式实现，而想要做到，总不能什么都没有，来个巧妇难为无米之炊的境地吧，所以说，米必须要有滴，在Spring中就是一个bean，也就是说，容器里得有米，再官话点就是上下文中得存在所需要的bean。同样模块化中两个互相隔离的模">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="https://muyinchen.github.io/2017/11/07/Refresh your Java skills--聊聊Java9 中模块化设计是如何实现IOC依赖注入效果的/">


  <title> Refresh your Java skills--聊聊Java9 中模块化设计是如何实现类似IOC依赖注入效果及与其区别 | 一叶知秋 </title>
</head>

<body itemscope="" itemtype="//schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=UA-83014983-1";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">一叶知秋</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule" rel="section">
            
            日程
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Refresh your Java skills--聊聊Java9 中模块化设计是如何实现类似IOC依赖注入效果及与其区别
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-11-07T20:00:25+08:00" content="2017-11-07">
              2017-11-07
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope="" itemtype="https://schema.org/Thing">
                  <a href="/categories/Java9/" itemprop="url" rel="index">
                    <span itemprop="name">Java9</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/11/07/Refresh your Java skills--聊聊Java9 中模块化设计是如何实现IOC依赖注入效果的/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/11/07/Refresh your Java skills--聊聊Java9 中模块化设计是如何实现IOC依赖注入效果的/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
              &nbsp; | &nbsp;
              <span class="page-pv"><i class="fa fa-user"> 本站访客数 </i>
              <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>人次
              </span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Refresh-your-Java-skills–聊聊Java9-中模块化设计是如何实现类似IOC依赖注入效果及与其区别"><a href="#Refresh-your-Java-skills–聊聊Java9-中模块化设计是如何实现类似IOC依赖注入效果及与其区别" class="headerlink" title="Refresh your Java skills–聊聊Java9 中模块化设计是如何实现类似IOC依赖注入效果及与其区别"></a>Refresh your Java skills–聊聊Java9 中模块化设计是如何实现类似IOC依赖注入效果及与其区别</h1><h2 id="场景引入"><a href="#场景引入" class="headerlink" title="场景引入"></a>场景引入</h2><p>如何实现IOC的效果，我们可以来想想，无非就是一个隐式实现，而想要做到，总不能什么都没有，来个巧妇难为无米之炊的境地吧，所以说，米必须要有滴，在Spring中就是一个bean，也就是说，容器里得有米，再官话点就是上下文中得存在所需要的bean。同样模块化中两个互相隔离的模块想要达到这种效果，也要先往jvm里扔个对象进去的，然后<strong>who use ，who get</strong> 就可以了。<br><a id="more"></a><br>请看例子(可以认为是我们平常写的SpringMVC项目中的service-&gt;serviceImpl-&gt;controller):</p>
<h3 id="service接口化模块"><a href="#service接口化模块" class="headerlink" title="service接口化模块"></a>service接口化模块</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.api;</span><br><span class="line">      <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CodecFactory</span> </span>&#123;</span><br><span class="line">          <span class="function">Encoder <span class="title">getEncoder</span><span class="params">(String encodingName)</span></span>;</span><br><span class="line">          <span class="function">Decoder <span class="title">getDecoder</span><span class="params">(String encodingName)</span></span>;</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>上面这个接口所在的模块定义:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> migo.codec.api &#123;</span><br><span class="line">   <span class="keyword">exports</span> com.example.api;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="serviceImpl化模块"><a href="#serviceImpl化模块" class="headerlink" title="serviceImpl化模块"></a>serviceImpl化模块</h3><p>接着，我们定义一个实现模块:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> migo.codec.service &#123;</span><br><span class="line">   <span class="keyword">requires</span> com.example.api;</span><br><span class="line"></span><br><span class="line">   provides com.example.api.CodecFactory with com.example.service.codec.CodecFactoryImpl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体实现就省略了。</p>
<h3 id="controller化模块"><a href="#controller化模块" class="headerlink" title="controller化模块"></a>controller化模块</h3><p>最后我们在最上层的模块内使用:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> migo.codec.controller &#123;</span><br><span class="line">   <span class="keyword">requires</span> migo.codec.api;</span><br><span class="line"></span><br><span class="line">   uses com.example.api.CodecFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体的controller模块内使用的代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ServiceLoader&lt;CodecFactory&gt; loader = ServiceLoader.load(CodecFactory.class);</span><br><span class="line">      <span class="keyword">for</span> (CodecFactory factory : loader) &#123;</span><br><span class="line">          Encoder enc = factory.getEncoder(<span class="string">"PNG"</span>);</span><br><span class="line">          <span class="keyword">if</span> (enc != <span class="keyword">null</span>)</span><br><span class="line">              ... use enc to encode a PNG file</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>
<p>或者:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    CodecFactory cf =</span><br><span class="line">      ServiceLoader.load(CodecFactory.class)</span><br><span class="line">                   .findFirst()</span><br><span class="line">                   .orElse(getFallBack());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(cf == <span class="keyword">null</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">"Using a fallback"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"Found a service"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CodecFactory <span class="title">getFallBack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>亦或者假如有很多服务实现的提供者，而某个提供服务实现的provider(也就是serviceImpl)上面有添加注解<code>@PNG</code>，而我们想使用带有这个注解的实例，可以使用以下代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ServiceLoader&lt;CodecFactory&gt; loader = ServiceLoader.load(CodecFactory.class);</span><br><span class="line">      Set&lt;CodecFactory&gt; pngFactories = loader</span><br><span class="line">             .stream()                                              </span><br><span class="line">             .filter(p -&gt; p.type().isAnnotationPresent(PNG.class))  </span><br><span class="line">             .map(Provider::get)                                   </span><br><span class="line">             .collect(Collectors.toSet());</span><br></pre></td></tr></table></figure>
<h2 id="内部工作机制原理"><a href="#内部工作机制原理" class="headerlink" title="内部工作机制原理"></a>内部工作机制原理</h2><h3 id="具体思路"><a href="#具体思路" class="headerlink" title="具体思路:"></a>具体思路:</h3><p>通过在模块定义里面的<strong>provides aaa with aaaImpl</strong> 这个功能，可以很容易的想到<code>key value</code>组合<br>当我们碰到这对关键字的时候，我们就会解析并将<code>aaa</code>做为<code>key</code>，<code>aaaImpl</code>添加到一个<code>list</code>中并将这个<code>list</code>作为<code>value</code>，并添加到一个<code>Map&lt;String,list&gt;</code>中<br>在我们碰到<code>uses</code>关键字（源码里面<code>acc</code>会去确定这个权限），并通过<code>ServiceLoader.load(key)</code>来找到这个key所对应的一个包含了实现类具体地址的list，可能有多个，那么，拓展功能，我们使用一个装饰模式，也就是继承了<code>Iterable</code>这个接口，可以达到遍历并生成具体实例来达到要求。</p>
<h3 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h3><h3 id="确定米粒的路径"><a href="#确定米粒的路径" class="headerlink" title="确定米粒的路径"></a>确定米粒的路径</h3><p>那么按照这个思路，我们反着来找下，这里只列关键代码:</p>
<p>从上面的Demo中，我们可以看到，通过类的class字节码来加载:</p>
<p>之前有说，巧妇难为无米之炊，所以这个上下文很重要，我们的类加载器也是要讲究上下文的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Creates a new service loader for the given service type, using the</span></span><br><span class="line"><span class="comment">    * current thread's &#123;<span class="doctag">@linkplain</span> java.lang.Thread#getContextClassLoader</span></span><br><span class="line"><span class="comment">    * context class loader&#125;.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt; An invocation of this convenience method of the form</span></span><br><span class="line"><span class="comment">    * &lt;pre&gt;&#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">    *     ServiceLoader.load(service)</span></span><br><span class="line"><span class="comment">    * &#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * is equivalent to</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;pre&gt;&#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">    *     ServiceLoader.load(service, Thread.currentThread().getContextClassLoader())</span></span><br><span class="line"><span class="comment">    * &#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@apiNote</span> Service loader objects obtained with this method should not be</span></span><br><span class="line"><span class="comment">    * cached VM-wide. For example, different applications in the same VM may</span></span><br><span class="line"><span class="comment">    * have different thread context class loaders. A lookup by one application</span></span><br><span class="line"><span class="comment">    * may locate a service provider that is only visible via its thread</span></span><br><span class="line"><span class="comment">    * context class loader and so is not suitable to be located by the other</span></span><br><span class="line"><span class="comment">    * application. Memory leaks can also arise. A thread local may be suited</span></span><br><span class="line"><span class="comment">    * to some applications.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span>  &lt;S&gt; the class of the service type</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span>  service</span></span><br><span class="line"><span class="comment">    *         The interface or abstract class representing the service</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> A new service loader</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> ServiceConfigurationError</span></span><br><span class="line"><span class="comment">    *         if the service type is not accessible to the caller or the</span></span><br><span class="line"><span class="comment">    *         caller is in an explicit module and its module descriptor does</span></span><br><span class="line"><span class="comment">    *         not declare that it uses &#123;<span class="doctag">@code</span> service&#125;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@revised</span> 9</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@spec</span> JPMS</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@CallerSensitive</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ServiceLoader&lt;S&gt; <span class="title">load</span><span class="params">(Class&lt;S&gt; service)</span> </span>&#123;</span><br><span class="line">       ClassLoader cl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ServiceLoader&lt;&gt;(Reflection.getCallerClass(), service, cl);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>我们进去这个<code>ServiceLoader</code>，其实无非就是一个构造器而已了，关键代码我截下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.service = svc;</span><br><span class="line">      <span class="keyword">this</span>.serviceName = svc.getName();</span><br><span class="line">      <span class="keyword">this</span>.layer = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">this</span>.loader = cl;</span><br><span class="line">      <span class="keyword">this</span>.acc = (System.getSecurityManager() != <span class="keyword">null</span>)</span><br><span class="line">              ? AccessController.getContext()</span><br><span class="line">              : <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>有了这个加载器之后，其实我们就拿到了上下文和访问权限的一些东西，我们再来看看这个类的字段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLoader</span>&lt;<span class="title">S</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">S</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// The class or interface representing the service being loaded</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;S&gt; service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The class of the service type</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String serviceName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The module layer used to locate providers; null when locating</span></span><br><span class="line">    <span class="comment">// providers using a class loader</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ModuleLayer layer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The class loader used to locate, load, and instantiate providers;</span></span><br><span class="line">    <span class="comment">// null when locating provider using a module layer</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader loader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The access control context taken when the ServiceLoader is created</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccessControlContext acc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The lazy-lookup iterator for iterator operations</span></span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;Provider&lt;S&gt;&gt; lookupIterator1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;S&gt; instantiatedProviders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The lazy-lookup iterator for stream operations</span></span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;Provider&lt;S&gt;&gt; lookupIterator2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Provider&lt;S&gt;&gt; loadedProviders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> loadedAllProviders; <span class="comment">// true when all providers loaded</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Incremented when reload is called</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> reloadCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JavaLangAccess LANG_ACCESS;</span><br></pre></td></tr></table></figure>
<p>可以看到，它实现了按照我们分析的<code>Iterable</code>接口，这样我们就可以多了很多操作，而且我们也看到了下面这几个东西，这样我们就可以做事情了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Iterator&lt;Provider&lt;S&gt;&gt; lookupIterator2;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Provider&lt;S&gt;&gt; loadedProviders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> loadedAllProviders; <span class="comment">// true when all providers loaded</span></span><br></pre></td></tr></table></figure>
<p>我们走进<code>findFirst</code>这个方法来看看:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Optional&lt;S&gt; <span class="title">findFirst</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator&lt;S&gt; iterator = iterator();</span><br><span class="line">        <span class="keyword">if</span> (iterator.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Optional.of(iterator.next());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Optional.empty();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们看到了<code>iterator()</code>这个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterator&lt;S&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// create lookup iterator if needed</span></span><br><span class="line">       <span class="keyword">if</span> (lookupIterator1 == <span class="keyword">null</span>) &#123;</span><br><span class="line">           lookupIterator1 = newLookupIterator();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Iterator&lt;S&gt;() &#123;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// record reload count</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> expectedReloadCount = ServiceLoader.<span class="keyword">this</span>.reloadCount;</span><br><span class="line">         ...</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>现在<code>newLookupIterator()</code>进入到我们的视野中，没有条件创建条件，刚开始我们可没有拿到米，现在去找米去:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns a new lookup iterator.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> Iterator&lt;Provider&lt;S&gt;&gt; newLookupIterator() &#123;</span><br><span class="line">       <span class="keyword">assert</span> layer == <span class="keyword">null</span> || loader == <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (layer != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> LayerLookupIterator&lt;&gt;();</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Iterator&lt;Provider&lt;S&gt;&gt; first = <span class="keyword">new</span> ModuleServicesLookupIterator&lt;&gt;();</span><br><span class="line">           Iterator&lt;Provider&lt;S&gt;&gt; second = <span class="keyword">new</span> LazyClassPathLookupIterator&lt;&gt;();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> Iterator&lt;Provider&lt;S&gt;&gt;() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                   <span class="keyword">return</span> (first.hasNext() || second.hasNext());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> Provider&lt;S&gt; <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                   <span class="keyword">if</span> (first.hasNext()) &#123;</span><br><span class="line">                       <span class="keyword">return</span> first.next();</span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (second.hasNext()) &#123;</span><br><span class="line">                       <span class="keyword">return</span> second.next();</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里抛开其他我们来看<code>ModuleServicesLookupIterator()</code>这个构造函数 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ModuleServicesLookupIterator() &#123;</span><br><span class="line">            <span class="keyword">this</span>.currentLoader = loader;</span><br><span class="line">            <span class="keyword">this</span>.iterator = iteratorFor(loader);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>映入眼帘的是<code>iteratorFor(ClassLoader loader)</code>这个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Returns an iterator to iterate over the implementations of &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">         * service&#125; in modules defined to the given class loader or in custom</span></span><br><span class="line"><span class="comment">         * layers with a module defined to this class loader.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Iterator&lt;ServiceProvider&gt; <span class="title">iteratorFor</span><span class="params">(ClassLoader loader)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// modules defined to the class loader</span></span><br><span class="line">            ServicesCatalog catalog;</span><br><span class="line">            <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                catalog = BootLoader.getServicesCatalog();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                catalog = ServicesCatalog.getServicesCatalogOrNull(loader);</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">//此处往下到我中文标记结束就是我们的正主了</span></span><br><span class="line">            List&lt;ServiceProvider&gt; providers;</span><br><span class="line">            <span class="keyword">if</span> (catalog == <span class="keyword">null</span>) &#123;</span><br><span class="line">                providers = List.of();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                providers = catalog.findServices(serviceName);</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="comment">//结束</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// modules in layers that define modules to the class loader</span></span><br><span class="line">            ClassLoader platformClassLoader = ClassLoaders.platformClassLoader();</span><br><span class="line">            <span class="keyword">if</span> (loader == <span class="keyword">null</span> || loader == platformClassLoader) &#123;</span><br><span class="line">                <span class="keyword">return</span> providers.iterator();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                List&lt;ServiceProvider&gt; allProviders = <span class="keyword">new</span> ArrayList&lt;&gt;(providers);</span><br><span class="line">                Iterator&lt;ModuleLayer&gt; iterator = LANG_ACCESS.layers(loader).iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    ModuleLayer layer = iterator.next();</span><br><span class="line">                    <span class="keyword">for</span> (ServiceProvider sp : providers(layer)) &#123;</span><br><span class="line">                        ClassLoader l = loaderFor(sp.<span class="keyword">module</span>());</span><br><span class="line">                        <span class="keyword">if</span> (l != <span class="keyword">null</span> &amp;&amp; l != platformClassLoader) &#123;</span><br><span class="line">                            allProviders.add(sp);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> allProviders.iterator();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这里终于找到了<code>findServices(String service)</code>这个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns the (possibly empty) list of service providers that implement</span></span><br><span class="line"><span class="comment">    * the given service type.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;ServiceProvider&gt; <span class="title">findServices</span><span class="params">(String service)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> map.getOrDefault(service, Collections.emptyList());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>结合<code>getOrDefault</code>的源码可知:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">default</span> V <span class="title">getOrDefault</span><span class="params">(Object key, V defaultValue)</span> </span>&#123;</span><br><span class="line">       V v;</span><br><span class="line">       <span class="keyword">return</span> (((v = get(key)) != <span class="keyword">null</span>) || containsKey(key))</span><br><span class="line">           ? v</span><br><span class="line">           : defaultValue;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>是不是和我们的具体思路接上轨了</p>
<h3 id="拿到我们想要的大米"><a href="#拿到我们想要的大米" class="headerlink" title="拿到我们想要的大米"></a>拿到我们想要的大米</h3><p>而我们的<code>provider</code>实例从何而来，请容我娓娓道来咯：</p>
<p>我们从<code>jdk.internal.module.Modules</code>这个模块定义类中可以找到<code>addProvides</code>这个方法，也就是说在我们加载这个模块的时候，这个动作就已经要干活了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Updates module m to provide a service</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addProvides</span><span class="params">(Module m, Class&lt;?&gt; service, Class&lt;?&gt; impl)</span> </span>&#123;</span><br><span class="line">      ModuleLayer layer = m.getLayer();</span><br><span class="line"></span><br><span class="line">      PrivilegedAction&lt;ClassLoader&gt; pa = m::getClassLoader;</span><br><span class="line">      ClassLoader loader = AccessController.doPrivileged(pa);</span><br><span class="line"></span><br><span class="line">      ClassLoader platformClassLoader = ClassLoaders.platformClassLoader();</span><br><span class="line">      <span class="keyword">if</span> (layer == <span class="keyword">null</span> || loader == <span class="keyword">null</span> || loader == platformClassLoader) &#123;</span><br><span class="line">          <span class="comment">// update ClassLoader catalog</span></span><br><span class="line">          ServicesCatalog catalog;</span><br><span class="line">          <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">              catalog = BootLoader.getServicesCatalog();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              catalog = ServicesCatalog.getServicesCatalog(loader);</span><br><span class="line">          &#125;</span><br><span class="line">          catalog.addProvider(m, service, impl);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (layer != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// update Layer catalog</span></span><br><span class="line">          JLA.getServicesCatalog(layer).addProvider(m, service, impl);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>然后我们可以从<code>sun.instrument.InstrumentationImpl</code>这个类来看到其工作方式(通过其注释就可以看到这个类和JVM相关):</p>
<p>在加载模块的时候就执行了下面的代码，看下面<code>update provides</code>这个注释的代码可以知道其调用了上面的<code>addProvides</code>这个方法，而最后也是调用了<code>addProvider(m, service, impl)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Java side of the JPLIS implementation. Works in concert with a native JVMTI agent</span></span><br><span class="line"><span class="comment"> * to implement the JPLIS API set. Provides both the Java API implementation of</span></span><br><span class="line"><span class="comment"> * the Instrumentation interface and utility Java routines to support the native code.</span></span><br><span class="line"><span class="comment"> * Keeps a pointer to the native data structure in a scalar field to allow native</span></span><br><span class="line"><span class="comment"> * processing behind native methods.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstrumentationImpl</span> <span class="keyword">implements</span> <span class="title">Instrumentation</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">redefineModule</span><span class="params">(Module <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Set&lt;Module&gt; extraReads,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Map&lt;String, Set&lt;Module&gt;&gt; extraExports,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Map&lt;String, Set&lt;Module&gt;&gt; extraOpens,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Set&lt;Class&lt;?&gt;&gt; extraUses,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Map&lt;Class&lt;?&gt;, List&lt;Class&lt;?&gt;&gt;&gt; extraProvides)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">module</span>.isNamed())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isModifiableModule(<span class="keyword">module</span>))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnmodifiableModuleException(<span class="keyword">module</span>.getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// copy and check reads</span></span><br><span class="line">        extraReads = <span class="keyword">new</span> HashSet&lt;&gt;(extraReads);</span><br><span class="line">        <span class="keyword">if</span> (extraReads.contains(<span class="keyword">null</span>))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"'extraReads' contains null"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// copy and check exports and opens</span></span><br><span class="line">        extraExports = cloneAndCheckMap(<span class="keyword">module</span>, extraExports);</span><br><span class="line">        extraOpens = cloneAndCheckMap(<span class="keyword">module</span>, extraOpens);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// copy and check uses</span></span><br><span class="line">        extraUses = <span class="keyword">new</span> HashSet&lt;&gt;(extraUses);</span><br><span class="line">        <span class="keyword">if</span> (extraUses.contains(<span class="keyword">null</span>))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"'extraUses' contains null"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// copy and check provides</span></span><br><span class="line">        Map&lt;Class&lt;?&gt;, List&lt;Class&lt;?&gt;&gt;&gt; tmpProvides = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, List&lt;Class&lt;?&gt;&gt;&gt; e : extraProvides.entrySet()) &#123;</span><br><span class="line">            Class&lt;?&gt; service = e.getKey();</span><br><span class="line">            <span class="keyword">if</span> (service == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"'extraProvides' contains null"</span>);</span><br><span class="line">            List&lt;Class&lt;?&gt;&gt; providers = <span class="keyword">new</span> ArrayList&lt;&gt;(e.getValue());</span><br><span class="line">            <span class="keyword">if</span> (providers.isEmpty())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"list of providers is empty"</span>);</span><br><span class="line">            providers.forEach(p -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (p.getModule() != <span class="keyword">module</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(p + <span class="string">" not in "</span> + <span class="keyword">module</span>);</span><br><span class="line">                <span class="keyword">if</span> (!service.isAssignableFrom(p))</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(p + <span class="string">" is not a "</span> + service);</span><br><span class="line">            &#125;);</span><br><span class="line">            tmpProvides.put(service, providers);</span><br><span class="line">        &#125;</span><br><span class="line">        extraProvides = tmpProvides;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// update reads</span></span><br><span class="line">        extraReads.forEach(m -&gt; Modules.addReads(<span class="keyword">module</span>, m));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// update exports</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Set&lt;Module&gt;&gt; e : extraExports.entrySet()) &#123;</span><br><span class="line">            String pkg = e.getKey();</span><br><span class="line">            Set&lt;Module&gt; targets = e.getValue();</span><br><span class="line">            targets.forEach(m -&gt; Modules.addExports(<span class="keyword">module</span>, pkg, m));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// update opens</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Set&lt;Module&gt;&gt; e : extraOpens.entrySet()) &#123;</span><br><span class="line">            String pkg = e.getKey();</span><br><span class="line">            Set&lt;Module&gt; targets = e.getValue();</span><br><span class="line">            targets.forEach(m -&gt; Modules.addOpens(<span class="keyword">module</span>, pkg, m));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// update uses</span></span><br><span class="line">        extraUses.forEach(service -&gt; Modules.addUses(<span class="keyword">module</span>, service));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// update provides</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, List&lt;Class&lt;?&gt;&gt;&gt; e : extraProvides.entrySet()) &#123;</span><br><span class="line">            Class&lt;?&gt; service = e.getKey();</span><br><span class="line">            List&lt;Class&lt;?&gt;&gt; providers = e.getValue();</span><br><span class="line">            providers.forEach(p -&gt; Modules.addProvides(<span class="keyword">module</span>, service, p));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Instrumentation</code>接口有一段很重要的注释，大家自己看吧，就不多说了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This class provides services needed to instrument Java</span></span><br><span class="line"><span class="comment"> * programming language code.</span></span><br><span class="line"><span class="comment"> * Instrumentation is the addition of byte-codes to methods for the</span></span><br><span class="line"><span class="comment"> * purpose of gathering data to be utilized by tools.</span></span><br><span class="line"><span class="comment"> * Since the changes are purely additive, these tools do not modify</span></span><br><span class="line"><span class="comment"> * application state or behavior.</span></span><br><span class="line"><span class="comment"> * Examples of such benign tools include monitoring agents, profilers,</span></span><br><span class="line"><span class="comment"> * coverage analyzers, and event loggers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;P&gt;</span></span><br><span class="line"><span class="comment"> * There are two ways to obtain an instance of the</span></span><br><span class="line"><span class="comment"> * &lt;code&gt;Instrumentation&lt;/code&gt; interface:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;&lt;p&gt; When a JVM is launched in a way that indicates an agent</span></span><br><span class="line"><span class="comment"> *     class. In that case an &lt;code&gt;Instrumentation&lt;/code&gt; instance</span></span><br><span class="line"><span class="comment"> *     is passed to the &lt;code&gt;premain&lt;/code&gt; method of the agent class.</span></span><br><span class="line"><span class="comment"> *     &lt;/p&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;&lt;p&gt; When a JVM provides a mechanism to start agents sometime</span></span><br><span class="line"><span class="comment"> *     after the JVM is launched. In that case an &lt;code&gt;Instrumentation&lt;/code&gt;</span></span><br><span class="line"><span class="comment"> *     instance is passed to the &lt;code&gt;agentmain&lt;/code&gt; method of the</span></span><br><span class="line"><span class="comment"> *     agent code. &lt;/p&gt; &lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * These mechanisms are described in the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@linkplain</span> java.lang.instrument package specification&#125;.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Once an agent acquires an &lt;code&gt;Instrumentation&lt;/code&gt; instance,</span></span><br><span class="line"><span class="comment"> * the agent may call methods on the instance at any time.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>   1.5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Instrumentation</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么，我们最后，走入<code>addProvider(m, service, impl)</code>这个方法中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add a provider in the given module to this services catalog</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@apiNote</span> This method is for use by java.lang.instrument</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProvider</span><span class="params">(Module <span class="keyword">module</span>, Class&lt;?&gt; service, Class&lt;?&gt; impl)</span> </span>&#123;</span><br><span class="line">        List&lt;ServiceProvider&gt; list = providers(service.getName());</span><br><span class="line">        list.add(<span class="keyword">new</span> ServiceProvider(<span class="keyword">module</span>, impl.getName()));</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceProvider</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String providerName;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ServiceProvider</span><span class="params">(Module <span class="keyword">module</span>, String providerName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.<span class="keyword">module</span> = <span class="keyword">module</span>;</span><br><span class="line">            <span class="keyword">this</span>.providerName = providerName;</span><br><span class="line">        &#125;</span><br><span class="line">   ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>再经过了这么曲曲折折的过程，终于拿到了<code>ServiceProvider</code>,里面包括了我们所要调用实现类的地址信息</p>
<p>于是，看下ServiceLoader这个类定义的<code>Provider</code>静态内部接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Represents a service provider located by &#123;<span class="doctag">@code</span> ServiceLoader&#125;.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt; When using a loader's &#123;<span class="doctag">@link</span> ServiceLoader#stream() stream()&#125; method</span></span><br><span class="line"><span class="comment">   * then the elements are of type &#123;<span class="doctag">@code</span> Provider&#125;. This allows processing</span></span><br><span class="line"><span class="comment">   * to select or filter on the provider class without instantiating the</span></span><br><span class="line"><span class="comment">   * provider. &lt;/p&gt;</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span>  &lt;S&gt; The service type</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@since</span> 9</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@spec</span> JPMS</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">Provider</span>&lt;<span class="title">S</span>&gt; <span class="keyword">extends</span> <span class="title">Supplier</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Returns the provider type. There is no guarantee that this type is</span></span><br><span class="line"><span class="comment">       * accessible or that it has a public no-args constructor. The &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">       * #get() get()&#125; method should be used to obtain the provider instance.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;p&gt; When a module declares that the provider class is created by a</span></span><br><span class="line"><span class="comment">       * provider factory then this method returns the return type of its</span></span><br><span class="line"><span class="comment">       * public static "&#123;<span class="doctag">@code</span> provider()&#125;" method.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@return</span> The provider type</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      Class&lt;? extends S&gt; type();</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Returns an instance of the provider.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@return</span> An instance of the provider.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@throws</span> ServiceConfigurationError</span></span><br><span class="line"><span class="comment">       *         If the service provider cannot be instantiated, or in the</span></span><br><span class="line"><span class="comment">       *         case of a provider factory, the public static</span></span><br><span class="line"><span class="comment">       *         "&#123;<span class="doctag">@code</span> provider()&#125;" method returns &#123;<span class="doctag">@code</span> null&#125; or throws</span></span><br><span class="line"><span class="comment">       *         an error or exception. The &#123;<span class="doctag">@code</span> ServiceConfigurationError&#125;</span></span><br><span class="line"><span class="comment">       *         will carry an appropriate cause where possible.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="meta">@Override</span> <span class="function">S <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>然后我们回到之前追到的<code>iteratorFor</code>方法，知道其返回的是 <code>Iterator&lt;ServiceProvider&gt;</code>类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Returns an iterator to iterate over the implementations of &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">        * service&#125; in modules defined to the given class loader or in custom</span></span><br><span class="line"><span class="comment">        * layers with a module defined to this class loader.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="function"><span class="keyword">private</span> Iterator&lt;ServiceProvider&gt; <span class="title">iteratorFor</span><span class="params">(ClassLoader loader)</span> </span>&#123;</span><br><span class="line">           <span class="comment">// modules defined to the class loader</span></span><br><span class="line">           ServicesCatalog catalog;</span><br><span class="line">           <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">               catalog = BootLoader.getServicesCatalog();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               catalog = ServicesCatalog.getServicesCatalogOrNull(loader);</span><br><span class="line">           &#125;</span><br><span class="line">           List&lt;ServiceProvider&gt; providers;</span><br><span class="line">           <span class="keyword">if</span> (catalog == <span class="keyword">null</span>) &#123;</span><br><span class="line">               providers = List.of();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               providers = catalog.findServices(serviceName);</span><br><span class="line">           &#125;</span><br><span class="line">         ...</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p> 然后回到<code>ModuleServicesLookupIterator()</code>这个构造函数，直接看这个内部类,也就是调用这个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Implements lazy service provider lookup of service providers that</span></span><br><span class="line"><span class="comment">    * are provided by modules defined to a class loader or to modules in</span></span><br><span class="line"><span class="comment">    * layers with a module defined to the class loader.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ModuleServicesLookupIterator</span>&lt;<span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class">       <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Provider</span>&lt;<span class="title">T</span>&gt;&gt;</span></span><br><span class="line"><span class="class">   </span>&#123;</span><br><span class="line">       ClassLoader currentLoader;</span><br><span class="line">       Iterator&lt;ServiceProvider&gt; iterator;</span><br><span class="line"></span><br><span class="line">       Provider&lt;T&gt; nextProvider;</span><br><span class="line">       ServiceConfigurationError nextError;</span><br><span class="line"></span><br><span class="line">       ModuleServicesLookupIterator() &#123;</span><br><span class="line">           <span class="keyword">this</span>.currentLoader = loader;</span><br><span class="line">           <span class="keyword">this</span>.iterator = iteratorFor(loader);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>在<code>newLookupIterator</code>这个方法中得到<code>ModuleServicesLookupIterator</code>的实例<code>first</code>,并调用其<code>hasNext</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns a new lookup iterator.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> Iterator&lt;Provider&lt;S&gt;&gt; newLookupIterator() &#123;</span><br><span class="line">       <span class="keyword">assert</span> layer == <span class="keyword">null</span> || loader == <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (layer != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> LayerLookupIterator&lt;&gt;();</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Iterator&lt;Provider&lt;S&gt;&gt; first = <span class="keyword">new</span> ModuleServicesLookupIterator&lt;&gt;();</span><br><span class="line">           Iterator&lt;Provider&lt;S&gt;&gt; second = <span class="keyword">new</span> LazyClassPathLookupIterator&lt;&gt;();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> Iterator&lt;Provider&lt;S&gt;&gt;() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                   <span class="keyword">return</span> (first.hasNext() || second.hasNext());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> Provider&lt;S&gt; <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                   <span class="keyword">if</span> (first.hasNext()) &#123;</span><br><span class="line">                       <span class="keyword">return</span> first.next();</span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (second.hasNext()) &#123;</span><br><span class="line">                       <span class="keyword">return</span> second.next();</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>我们来进入这个<code>hasNext</code>方法，也就是在这里，调用了<code>loadProvider</code>生成了一个bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (nextProvider == <span class="keyword">null</span> &amp;&amp; nextError == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// get next provider to load</span></span><br><span class="line">            <span class="keyword">while</span> (!iterator.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (currentLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    currentLoader = currentLoader.getParent();</span><br><span class="line">                    iterator = iteratorFor(currentLoader);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// attempt to load provider</span></span><br><span class="line">            ServiceProvider provider = iterator.next();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                Provider&lt;T&gt; next = (Provider&lt;T&gt;) loadProvider(provider);</span><br><span class="line">                nextProvider = next;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServiceConfigurationError e) &#123;</span><br><span class="line">                nextError = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Provider&lt;T&gt; <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasNext())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line"></span><br><span class="line">        Provider&lt;T&gt; provider = nextProvider;</span><br><span class="line">        <span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">            nextProvider = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> provider;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ServiceConfigurationError e = nextError;</span><br><span class="line">            <span class="keyword">assert</span> e != <span class="keyword">null</span>;</span><br><span class="line">            nextError = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>走进这个<code>loadProvider</code>方法,抛开前面所有，我们只看最后返回为:<code>new ProviderImpl&lt;S&gt;(service, type, ctor, acc)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Loads a service provider in a module.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Returns &#123;<span class="doctag">@code</span> null&#125; if the service provider's module doesn't read</span></span><br><span class="line"><span class="comment">     * the module with the service type.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ServiceConfigurationError if the class cannot be loaded or</span></span><br><span class="line"><span class="comment">     *         isn't the expected sub-type (or doesn't define a provider</span></span><br><span class="line"><span class="comment">     *         factory method that returns the expected type)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Provider&lt;S&gt; <span class="title">loadProvider</span><span class="params">(ServiceProvider provider)</span> </span>&#123;</span><br><span class="line">        Module <span class="keyword">module</span> = provider.<span class="keyword">module</span>();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">module</span>.canRead(service.getModule())) &#123;</span><br><span class="line">            <span class="comment">// module does not read the module with the service type</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String cn = provider.providerName();</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (acc == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz = Class.forName(<span class="keyword">module</span>, cn);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LinkageError e) &#123;</span><br><span class="line">                fail(service, <span class="string">"Unable to load "</span> + cn, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PrivilegedExceptionAction&lt;Class&lt;?&gt;&gt; pa = () -&gt; Class.forName(<span class="keyword">module</span>, cn);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz = AccessController.doPrivileged(pa);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PrivilegedActionException pae) &#123;</span><br><span class="line">                Throwable x = pae.getCause();</span><br><span class="line">                fail(service, <span class="string">"Unable to load "</span> + cn, x);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            fail(service, <span class="string">"Provider "</span> + cn + <span class="string">" not found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> mods = clazz.getModifiers();</span><br><span class="line">        <span class="keyword">if</span> (!Modifier.isPublic(mods)) &#123;</span><br><span class="line">            fail(service, clazz + <span class="string">" is not public"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if provider in explicit module then check for static factory method</span></span><br><span class="line">        <span class="keyword">if</span> (inExplicitModule(clazz)) &#123;</span><br><span class="line">            Method factoryMethod = findStaticProviderMethod(clazz);</span><br><span class="line">            <span class="keyword">if</span> (factoryMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Class&lt;?&gt; returnType = factoryMethod.getReturnType();</span><br><span class="line">                <span class="keyword">if</span> (!service.isAssignableFrom(returnType)) &#123;</span><br><span class="line">                    fail(service, factoryMethod + <span class="string">" return type not a subtype"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                Class&lt;? extends S&gt; type = (Class&lt;? extends S&gt;) returnType;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ProviderImpl&lt;S&gt;(service, type, factoryMethod, acc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// no factory method so must be a subtype</span></span><br><span class="line">        <span class="keyword">if</span> (!service.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            fail(service, clazz.getName() + <span class="string">" not a subtype"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        Class&lt;? extends S&gt; type = (Class&lt;? extends S&gt;) clazz;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        Constructor&lt;? extends S&gt; ctor = (Constructor&lt;? extends S&gt; ) getConstructor(clazz);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProviderImpl&lt;S&gt;(service, type, ctor, acc);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们通过查看这个<code>ProviderImpl</code>类终于得到了我们想要得到的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * A Provider implementation that supports invoking, with reduced</span></span><br><span class="line"><span class="comment">    * permissions, the static factory to obtain the provider or the</span></span><br><span class="line"><span class="comment">    * provider's no-arg constructor.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderImpl</span>&lt;<span class="title">S</span>&gt; <span class="keyword">implements</span> <span class="title">Provider</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> Class&lt;S&gt; service;</span><br><span class="line">       <span class="keyword">final</span> Class&lt;? extends S&gt; type;</span><br><span class="line">       <span class="keyword">final</span> Method factoryMethod;  <span class="comment">// factory method or null</span></span><br><span class="line">       <span class="keyword">final</span> Constructor&lt;? extends S&gt; ctor; <span class="comment">// public no-args constructor or null</span></span><br><span class="line">       <span class="keyword">final</span> AccessControlContext acc;</span><br><span class="line"></span><br><span class="line">       ProviderImpl(Class&lt;S&gt; service,</span><br><span class="line">                    Class&lt;? extends S&gt; type,</span><br><span class="line">                    Method factoryMethod,</span><br><span class="line">                    AccessControlContext acc) &#123;</span><br><span class="line">           <span class="keyword">this</span>.service = service;</span><br><span class="line">           <span class="keyword">this</span>.type = type;</span><br><span class="line">           <span class="keyword">this</span>.factoryMethod = factoryMethod;</span><br><span class="line">           <span class="keyword">this</span>.ctor = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">this</span>.acc = acc;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ProviderImpl(Class&lt;S&gt; service,</span><br><span class="line">                    Class&lt;? extends S&gt; type,</span><br><span class="line">                    Constructor&lt;? extends S&gt; ctor,</span><br><span class="line">                    AccessControlContext acc) &#123;</span><br><span class="line">           <span class="keyword">this</span>.service = service;</span><br><span class="line">           <span class="keyword">this</span>.type = type;</span><br><span class="line">           <span class="keyword">this</span>.factoryMethod = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">this</span>.ctor = ctor;</span><br><span class="line">           <span class="keyword">this</span>.acc = acc;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">public</span> Class&lt;? extends S&gt; type() &#123;</span><br><span class="line">           <span class="keyword">return</span> type;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> S <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (factoryMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> invokeFactoryMethod();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> newInstance();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>IOC和模块化所提供的类似效果的最大的区别就是，前者是提供了实例化的bean(即便是通过AOP实现的，这点很重要，Java9模块化在使用Spring的时候会有特别的设置)，而且是基于Spring容器的单例的存在(多例注入的问题请参考我这方面的Spring源码解析)，后者是提供了class字节码所在的路径，用的时候内部会自行生成实例，所以是多例的。</p>
<p>其实整个过程，Java的模块化文件系统起了很大的作用(这块看情况假如篇幅比较长久不放在我的书里了)，然后自己追源码的思路也在这里给大家展现了一番，希望可以对大家有所帮助，看源码不要上来就瞎找的。另外，最重要的一点就是，不要因为源码很多，很复杂就轻言放弃，看的多了，看的久了，自然就有一套属于自己的方法论了。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://og0sybnix.bkt.clouddn.com/wechat-qcode.png" alt="知秋 WeChat Pay">
          <p>微信打赏</p>
        </div>
      
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag">#Java</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/17/Spring5源码解析-Spring中的异步和计划任务/" rel="next" title="Spring5源码解析-Spring中的异步和计划任务">
                <i class="fa fa-chevron-left"></i> Spring5源码解析-Spring中的异步和计划任务
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/12/Refresh your Java skills--聊聊Java9 中模块化所基于的文件系统 JRTFS/" rel="prev" title="Refresh your Java skills--聊聊Java9 中模块化所基于的文件系统 JRTFS">
                Refresh your Java skills--聊聊Java9 中模块化所基于的文件系统 JRTFS <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/11/07/Refresh your Java skills--聊聊Java9 中模块化设计是如何实现IOC依赖注入效果的/" data-title="Refresh your Java skills--聊聊Java9 中模块化设计是如何实现类似IOC依赖注入效果及与其区别" data-url="https://muyinchen.github.io/2017/11/07/Refresh your Java skills--聊聊Java9 中模块化设计是如何实现IOC依赖注入效果的/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image" src="http://og0sybnix.bkt.clouddn.com/18213496.jpg" alt="知秋">
          <p class="site-author-name" itemprop="name">知秋</p>
          <p class="site-description motion-element" itemprop="description">只记空山，只念新雨</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">97</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.csdn.net/lsgqjh" title="小舒哥" target="_blank">小舒哥</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Refresh-your-Java-skills–聊聊Java9-中模块化设计是如何实现类似IOC依赖注入效果及与其区别"><span class="nav-number">1.</span> <span class="nav-text">Refresh your Java skills–聊聊Java9 中模块化设计是如何实现类似IOC依赖注入效果及与其区别</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#场景引入"><span class="nav-number">1.1.</span> <span class="nav-text">场景引入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#service接口化模块"><span class="nav-number">1.1.1.</span> <span class="nav-text">service接口化模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#serviceImpl化模块"><span class="nav-number">1.1.2.</span> <span class="nav-text">serviceImpl化模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#controller化模块"><span class="nav-number">1.1.3.</span> <span class="nav-text">controller化模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内部工作机制原理"><span class="nav-number">1.2.</span> <span class="nav-text">内部工作机制原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#具体思路"><span class="nav-number">1.2.1.</span> <span class="nav-text">具体思路:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码解析"><span class="nav-number">1.2.2.</span> <span class="nav-text">源码解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#确定米粒的路径"><span class="nav-number">1.2.3.</span> <span class="nav-text">确定米粒的路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拿到我们想要的大米"><span class="nav-number">1.2.4.</span> <span class="nav-text">拿到我们想要的大米</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">知秋</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zhiqiuyy"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

  


</body>
</html>
